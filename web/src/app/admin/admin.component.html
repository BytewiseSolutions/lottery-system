<div class="admin-container">
  <div class="mobile-sidebar-overlay" [class.active]="isMobileSidebarOpen" (click)="closeMobileSidebar()"></div>
    
    <div class="admin-dashboard">
      <div class="sidebar" [class.mobile-open]="isMobileSidebarOpen">
        <app-admin-sidebar 
          [activeSection]="activeSection"
          [totalResults]="totalResults"
          [isConnected]="isConnected"
          [storageUsed]="storageUsed"
          [storageTotal]="storageTotal"
          [storagePercentage]="storagePercentage"
          [memoryUsage]="memoryUsage"
          [lastLogin]="lastLogin"
          (sectionChange)="onSectionChange($event); closeMobileSidebar()"
          (logoutClick)="onSidebarLogout()">
        </app-admin-sidebar>
      </div>

      <main class="main-content">

        <header class="top-bar">
          <div class="breadcrumb">
            <button class="mobile-sidebar-toggle" (click)="toggleMobileSidebar()">
              <i class="fas fa-bars"></i>
            </button>
            <a (click)="goHome()">Home</a>
            <i class="fas fa-chevron-right"></i>
            <span>{{ getPageTitle() }}</span>
          </div>
          
          <div class="top-bar-actions">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input 
                type="text" 
                placeholder="Search..." 
                [(ngModel)]="searchQuery"
                (input)="onSearch()">
            </div>
            <button class="btn-icon" (click)="refreshData()" title="Refresh">
              <i class="fas fa-sync-alt" [class.spin]="isRefreshing"></i>
            </button>
          </div>
        </header>

        <!-- Dashboard Section -->
        @if (activeSection === 'dashboard') {
          <section class="dashboard-section">
            <div class="stats-grid">
              <div class="stat-card primary">
                <div class="stat-icon">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ totalResults }}</h3>
                  <p>Total Results</p>
                  <span class="stat-trend positive">
                    <i class="fas fa-arrow-up"></i> {{ resultsGrowth }}% this month
                  </span>
                </div>
              </div>
              
              <div class="stat-card success">
                <div class="stat-icon">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ activeLotteries }}</h3>
                  <p>Active Lotteries</p>
                  <span class="stat-trend positive">
                    <i class="fas fa-arrow-up"></i> All running
                  </span>
                </div>
              </div>
              
              <div class="stat-card warning">
                <div class="stat-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ totalUsers }}</h3>
                  <p>Total Users</p>
                  <span class="stat-trend negative">
                    <i class="fas fa-arrow-down"></i> {{ usersGrowth }}% this week
                  </span>
                </div>
              </div>
              
              <div class="stat-card danger">
                <div class="stat-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ pendingActions }}</h3>
                  <p>Pending Actions</p>
                  <span class="stat-trend neutral">
                    <i class="fas fa-minus"></i> Needs attention
                  </span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3>Upcoming Draws</h3>
              </div>
              <div class="table-responsive">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Lottery</th>
                      <th>Draw Date</th>
                      <th>Jackpot</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (draw of upcomingDraws; track draw.id) {
                      <tr>
                        <td>{{ draw.lottery }}</td>
                        <td>
                          <input 
                            type="datetime-local" 
                            [value]="formatDateTimeForInput(draw.drawDate)"
                            (change)="updateDrawTime(draw, $event)"
                            class="form-control form-control-sm"
                            style="min-width: 180px;">
                        </td>
                        <td>{{ draw.jackpot }}</td>
                        <td>
                          <span class="status-badge" [class]="draw.status">
                            {{ draw.status }}
                          </span>
                        </td>
                        <td>
                          <div class="table-actions">
                            <button class="btn-icon success" title="Announce Winners" (click)="announceWinner(draw)">
                              <i class="fas fa-trophy"></i>
                            </button>
                            <button class="btn-icon" title="Edit Draw Time" (click)="editDrawTime(draw)">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon danger" title="Delete Draw" (click)="deleteDraw(draw.id)">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        }

        <!-- Upload Results Section -->
        @if (activeSection === 'upload') {
          <section class="upload-section">
            <div class="upload-trigger">
              <div class="upload-info">
                <div class="info-icon">
                  <i class="fas fa-upload"></i>
                </div>
                <div class="info-text">
                  <h2>Upload New Result</h2>
                  <p>Add lottery results to the system</p>
                </div>
              </div>
              <button class="btn-primary" (click)="showUploadModal = true">
                <i class="fas fa-plus"></i> Upload Result
              </button>
            </div>
          </section>
        }

        <!-- Confirmation Modal -->
        @if (showConfirmModal && confirmModalData) {
          <div class="modal-overlay" (click)="cancelAction()">
            <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>{{ confirmModalData.title }}</h3>
                <button class="btn-close" (click)="cancelAction()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="modal-body">
                <p>{{ confirmModalData.message }}</p>
              </div>
              
              <div class="modal-actions">
                <button class="btn btn-outline" (click)="cancelAction()">
                  Cancel
                </button>
                <button class="btn btn-danger" (click)="confirmAction()">
                  Confirm
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Upload Success Modal -->
        @if (showSuccessModal && uploadSuccessData) {
          <div class="modal-overlay" (click)="showSuccessModal = false">
            <div class="modal-content success-modal large-modal" (click)="$event.stopPropagation()">
              <div class="modal-header success" [class.error]="uploadSuccessData.isError">
                <div class="success-icon" [class.error-icon]="uploadSuccessData.isError">
                  <i class="fas" [class.fa-check-circle]="!uploadSuccessData.isError" [class.fa-exclamation-circle]="uploadSuccessData.isError"></i>
                </div>
                <h3>{{ uploadSuccessData.isError ? 'Error' : (uploadSuccessData.message ? 'Success' : 'Result Uploaded Successfully!') }}</h3>
                <button class="btn-close" (click)="showSuccessModal = false">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="modal-body">
                @if (uploadSuccessData.message && !uploadSuccessData.lottery) {
                  <p>{{ uploadSuccessData.message }}</p>
                } @else {
                  <div class="result-summary">
                    <div class="summary-grid">
                      <div class="summary-item">
                        <label>Lottery:</label>
                        <span>{{ uploadSuccessData.lottery }}</span>
                      </div>
                      <div class="summary-item">
                        <label>Draw Date:</label>
                        <span>{{ uploadSuccessData.drawDate | date:'medium' }}</span>
                      </div>
                      <div class="summary-item">
                        <label>Jackpot:</label>
                        <span>${{ uploadSuccessData.jackpot }}</span>
                      </div>
                      <div class="summary-item">
                        <label>Status:</label>
                        <span class="status-badge published">{{ uploadSuccessData.status || 'Published' }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="numbers-display">
                    <div class="winning-numbers-display">
                      <label>Winning Numbers:</label>
                      <div class="numbers-row horizontal">
                        @for (num of uploadSuccessData.winningNumbers; track $index) {
                          <span class="number-badge winning">{{ num }}</span>
                        }
                      </div>
                    </div>
                    
                    <div class="bonus-numbers-display">
                      <label>Bonus Numbers:</label>
                      <div class="numbers-row horizontal">
                        @for (num of uploadSuccessData.bonusNumbers; track $index) {
                          <span class="number-badge bonus">{{ num }}</span>
                        }
                      </div>
                    </div>
                  </div>

                  <div class="winners-summary">
                    <div class="winners-count">
                      <div class="count-display">
                        <span class="count">{{ uploadSuccessData.winners }}</span>
                        <span class="label">Winners Found</span>
                      </div>
                      @if (uploadSuccessData.totalEntries) {
                        <div class="entries-info">
                          <small>Out of {{ uploadSuccessData.totalEntries }} total entries</small>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
              
              <div class="modal-actions">
                <button class="btn btn-primary" (click)="showSuccessModal = false">
                  <i class="fas fa-check"></i> Continue
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Upload Modal -->
        @if (showUploadModal) {
          <div class="modal-overlay" (click)="showUploadModal = false">
            <div class="modal-content upload-modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Upload New Result</h3>
                <button class="btn-close" (click)="showUploadModal = false">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <form [formGroup]="uploadForm" (ngSubmit)="uploadResult()" class="modal-form">
                <div class="form-group">
                  <label for="lottery">Lottery Type</label>
                  <select id="lottery" formControlName="lottery" class="form-control select-field" required>
                    <option value="" disabled>Select lottery type</option>
                    <option value="Monday Lotto">Monday Lotto</option>
                    <option value="Wednesday Lotto">Wednesday Lotto</option>
                    <option value="Friday Lotto">Friday Lotto</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="drawDate">Draw Date</label>
                  <input 
                    type="datetime-local" 
                    id="drawDate"
                    formControlName="drawDate" 
                    class="form-control" 
                    required>
                </div>
                
                <div class="form-group">
                  <label for="jackpot">Jackpot (Millions)</label>
                  <input 
                    type="number" 
                    id="jackpot"
                    formControlName="jackpot" 
                    class="form-control" 
                    placeholder="15.50"
                    step="0.01"
                    required>
                </div>

                <div class="numbers-section">
                  <label>Winning Numbers (5 numbers required)</label>
                  <div class="numbers-grid">
                    @for (num of winningNumbers; track $index; let i = $index) {
                      <input 
                        type="number" 
                        [(ngModel)]="winningNumbers[i]" 
                        [ngModelOptions]="{standalone: true}"
                        class="number-ball" 
                        min="1" 
                        max="75"
                        (input)="validateNumber($event, i, 'winning')"
                        placeholder="{{ i + 1 }}"
                        required>
                    }
                  </div>
                  <div class="numbers-actions">
                    <button type="button" class="btn-secondary" (click)="clearNumbers()">
                      <i class="fas fa-refresh"></i> Clear All
                    </button>
                  </div>
                </div>

                <div class="numbers-section">
                  <label>Bonus Numbers (2 numbers required)</label>
                  <div class="numbers-grid bonus-grid">
                    @for (num of bonusNumbers; track $index; let i = $index) {
                      <input 
                        type="number" 
                        [(ngModel)]="bonusNumbers[i]" 
                        [ngModelOptions]="{standalone: true}"
                        class="number-ball bonus-ball" 
                        min="1" 
                        max="75"
                        (input)="validateNumber($event, i, 'bonus')"
                        placeholder="B{{ i + 1 }}"
                        required>
                    }
                  </div>
                  <div class="numbers-actions">
                    <button type="button" class="btn-secondary" (click)="clearBonusNumbers()">
                      <i class="fas fa-refresh"></i> Clear Bonus
                    </button>
                  </div>
                </div>

                <div class="modal-actions">
                  <div class="publish-option">
                    <input 
                      type="checkbox" 
                      id="publishNow" 
                      formControlName="publishNow"
                      class="checkbox">
                    <label for="publishNow">Publish immediately</label>
                  </div>
                  
                  <div class="action-buttons">
                    <button 
                      type="button" 
                      class="btn btn-outline"
                      (click)="saveDraft()"
                      [disabled]="uploadForm.invalid || isUploading"
                      style="margin-right: 12px;">
                      <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button 
                      type="submit" 
                      class="btn btn-primary"
                      [disabled]="uploadForm.invalid || isUploading">
                      @if (isUploading) {
                        <i class="fas fa-spinner fa-spin"></i> Uploading...
                      } @else {
                        <i class="fas fa-upload"></i> Upload Result
                      }
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        }

        <!-- Analytics Section -->
        @if (activeSection === 'analytics') {
          <app-analytics
            [analyticsRange]="analyticsRange"
            [analyticsData]="analyticsData"
            (rangeChange)="onAnalyticsRangeChange($event)"
            (customDateRange)="onCustomDateRange()">
          </app-analytics>
        }

        <!-- Manage Results Section -->
        @if (activeSection === 'manage') {
          <app-manage-results
            [results]="results"
            [paginatedResults]="paginatedResults"
            [selectedResults]="selectedResults"
            [bulkAction]="bulkAction"
            [currentPage]="currentPage"
            [totalPages]="totalPages"
            [totalResults]="totalResults"
            (uploadClick)="onUploadClick()"
            (exportClick)="onExportResults()"
            (selectAllChange)="onSelectAllChange($event)"
            (selectResultChange)="onSelectResultChange($event)"
            (viewResult)="onViewResult($event)"
            (editResult)="onEditResult($event)"
            (toggleStatus)="onToggleResultStatus($event)"
            (deleteResult)="onDeleteResult($event)"
            (bulkActionApply)="onBulkActionApply()"
            (pageChange)="onPageChange($event)">
          </app-manage-results>
        }

        <!-- User Management Section -->
        @if (activeSection === 'users') {
          <app-user-management
            [users]="users"
            [totalUsersCount]="totalUsersCount"
            [usersCurrentPage]="usersCurrentPage"
            [usersTotalPages]="usersTotalPages"
            [usersSearchQuery]="usersSearchQuery"
            (searchUsers)="onSearchUsers($event)"
            (addUser)="onAddUser()"
            (editUser)="onEditUser($event)"
            (deleteUser)="onDeleteUser($event)"
            (pageChange)="onUsersPageChange($event)">
          </app-user-management>
        }

        <!-- Activity Logs Section -->
        @if (activeSection === 'logs') {
          <app-activity-logs></app-activity-logs>
        }

        <!-- Settings Section -->
        @if (activeSection === 'settings') {
          <app-settings
            [settingsTab]="settingsTab"
            [siteSettings]="siteSettings"
            [timezones]="timezones"
            [apiKeys]="apiKeys"
            (tabChange)="onSettingsTabChange($event)"
            (saveSettings)="onSaveSettings()"
            (generateApiKey)="onGenerateApiKey()"
            (copyApiKey)="onCopyApiKey($event)"
            (revokeApiKey)="onRevokeApiKey($event)">
          </app-settings>
        }

        <!-- Edit Result Modal -->
        @if (editingResult) {
          <div class="modal-overlay" (click)="cancelEditResult()">
            <div class="modal-content edit-result-modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Edit Result</h3>
                <button class="btn-close" (click)="cancelEditResult()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <form [formGroup]="editResultForm" (ngSubmit)="saveEditResult()" class="modal-form">
                <div class="form-group">
                  <label for="editLottery">Lottery Type</label>
                  <select id="editLottery" formControlName="lottery" class="form-control" required>
                    <option value="Monday Lotto">Monday Lotto</option>
                    <option value="Wednesday Lotto">Wednesday Lotto</option>
                    <option value="Friday Lotto">Friday Lotto</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="editDrawDate">Draw Date</label>
                  <input type="datetime-local" id="editDrawDate" formControlName="drawDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                  <label for="editJackpot">Jackpot (Millions)</label>
                  <input type="number" id="editJackpot" formControlName="jackpot" class="form-control" step="0.01" required>
                </div>

                <div class="numbers-section">
                  <label>Winning Numbers (5 numbers required)</label>
                  <div class="numbers-grid">
                    @for (num of editWinningNumbers; track $index; let i = $index) {
                      <input 
                        type="number" 
                        [(ngModel)]="editWinningNumbers[i]" 
                        [ngModelOptions]="{standalone: true}"
                        class="number-ball" 
                        min="1" 
                        max="75"
                        (input)="validateEditNumber($event, i, 'winning')"
                        placeholder="{{ i + 1 }}"
                        required>
                    }
                  </div>
                </div>

                <div class="numbers-section">
                  <label>Bonus Numbers (2 numbers required)</label>
                  <div class="numbers-grid bonus-grid">
                    @for (num of editBonusNumbers; track $index; let i = $index) {
                      <input 
                        type="number" 
                        [(ngModel)]="editBonusNumbers[i]" 
                        [ngModelOptions]="{standalone: true}"
                        class="number-ball bonus-ball" 
                        min="1" 
                        max="75"
                        (input)="validateEditNumber($event, i, 'bonus')"
                        placeholder="B{{ i + 1 }}"
                        required>
                    }
                  </div>
                </div>

                <div class="form-group">
                  <label for="editStatus">Status</label>
                  <select id="editStatus" formControlName="status" class="form-control">
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                  </select>
                </div>

                <div class="modal-actions">
                  <button type="button" class="btn btn-outline" (click)="cancelEditResult()">Cancel</button>
                  <button type="submit" class="btn btn-primary" [disabled]="editResultForm.invalid">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        }

        <!-- Custom Date Range Modal -->
        @if (showCustomDateModal) {
          <div class="modal-overlay" (click)="cancelCustomDateRange()">
            <div class="modal-content custom-date-modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Select Date Range</h3>
                <button class="btn-close" (click)="cancelCustomDateRange()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="dateFrom">From Date</label>
                  <input type="date" id="dateFrom" [(ngModel)]="customDateFrom" class="form-control" required>
                </div>
                <div class="form-group">
                  <label for="dateTo">To Date</label>
                  <input type="date" id="dateTo" [(ngModel)]="customDateTo" class="form-control" required>
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn btn-outline" (click)="cancelCustomDateRange()">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="applyCustomDateRange()" [disabled]="!customDateFrom || !customDateTo">Apply Range</button>
              </div>
            </div>
          </div>
        }